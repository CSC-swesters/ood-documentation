

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>node_proxy_handler &mdash; Open OnDemand 1.7.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="analytics_handler" href="analytics-handler.html" />
    <link rel="prev" title="pun_proxy_handler" href="pun-proxy-handler.html" />
 
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-34776817-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-34776817-3');
</script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">General</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">Architecture</a></li>
</ul>
<p class="caption"><span class="caption-text">Install</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/add-cluster-config.html">Add Cluster Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/resource-manager.html">Resource Manager Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../customization_overview.html">Customization Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../customization.html">Customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../analytics.html">Analytics</a></li>
</ul>
<p class="caption"><span class="caption-text">Extend</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../app-development/interactive/setup.html">Setup Interactive Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../enable-desktops.html">Enable Interactive Desktop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install-ihpc-apps.html">Install Other Interactive Apps</a></li>
</ul>
<p class="caption"><span class="caption-text">Deploy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../app-authorization.html">App Authorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../app-sharing.html">App Sharing</a></li>
</ul>
<p class="caption"><span class="caption-text">Develop Interactive Apps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../app-development.html">App Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../app-development/tutorials-interactive-apps.html">Tutorials: Interactive Apps</a></li>
</ul>
<p class="caption"><span class="caption-text">Develop Passenger Apps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../app-development/tutorials-passenger-apps.html">Tutorials: Passenger Apps</a></li>
</ul>
<p class="caption"><span class="caption-text">Release Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes/v1.7-release-notes.html">v1.7 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes/v1.6-release-notes.html">v1.6 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes/v1.5-release-notes.html">v1.5 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes/v1.4-release-notes.html">v1.4 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes/v1.3-release-notes.html">v1.3 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes/v1.2-release-notes.html">v1.2 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes/v1.1-release-notes.html">v1.1 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes/v1.0-release-notes.html">v1.0 Release Notes</a></li>
</ul>
<p class="caption"><span class="caption-text">Known Issues</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../issues/overview.html">OnDemandâ€™s Known Issues</a></li>
</ul>
<p class="caption"><span class="caption-text">Legacy Docs</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../infrastructure.html">Infrastructure</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../ood-portal-generator.html">ood-portal-generator</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../mod-ood-proxy.html">mod_ood_proxy</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../usage.html">Usage</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="nginx-handler.html">nginx_handler</a></li>
<li class="toctree-l4"><a class="reference internal" href="pun-proxy-handler.html">pun_proxy_handler</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">node_proxy_handler</a></li>
<li class="toctree-l4"><a class="reference internal" href="analytics-handler.html">analytics_handler</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../ood-auth-map.html">ood_auth_map</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nginx-stage.html">nginx_stage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user-documentation.html">User Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Open OnDemand</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../infrastructure.html">Infrastructure</a> &raquo;</li>
        
          <li><a href="../../mod-ood-proxy.html">mod_ood_proxy</a> &raquo;</li>
        
          <li><a href="../usage.html">Usage</a> &raquo;</li>
        
      <li>node_proxy_handler</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/OSC/ood-documentation/blob/master/source/infrastructure/mod-ood-proxy/handlers/node-proxy-handler.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="node-proxy-handler">
<span id="id1"></span><h1>node_proxy_handler<a class="headerlink" href="#node-proxy-handler" title="Permalink to this headline">Â¶</a></h1>
<p>This handler proxies an authenticated userâ€™s traffic to a backend node running
a web server through an IP socket. A typical request follows the following
format:</p>
<dl class="get">
<dt id="get-(base_uri)-(host)-(port)-...">
<code class="descname">GET </code><code class="descname"></code><span class="sig-paren">(</span><em>base_uri</em><span class="sig-paren">)</span><code class="descname">/</code><span class="sig-paren">(</span><em>host</em><span class="sig-paren">)</span><code class="descname">/</code><span class="sig-paren">(</span><em>port</em><span class="sig-paren">)</span><code class="descname">/...</code><a class="headerlink" href="#get-(base_uri)-(host)-(port)-..." title="Permalink to this definition">Â¶</a></dt>
<dd><p>Proxies traffic to the web server running on <code class="docutils literal notranslate"><span class="pre">host</span></code> and <code class="docutils literal notranslate"><span class="pre">port</span></code>.</p>
</dd></dl>

<p>The actual URI request path can be altered depending on how you define this
handler in the Apache configuration file. There are two possibilities:</p>
<ol class="arabic">
<li><p class="first">To proxy the full URI request path to the web server you would define a
<code class="docutils literal notranslate"><span class="pre">LocationMatch</span></code> container in the Apache configuration file as such:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;LocationMatch ^/node/(?&lt;host&gt;[^]+)/(?&lt;port&gt;\d+)&gt;
  ...

  LuaHookFixups node_proxy.lua node_proxy_handler
&lt;/LocationMatch&gt;
</pre></div>
</div>
<p>This will take the following request:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/node/host001.hpc.edu/5000/index.html</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">ondemand.hpc.edu</span>
</pre></div>
</div>
<p>and generate a request to the backend web server as:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/node/host001.hpc.edu/5000/index.html</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">host001.hpc.edu</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The backend web server must be dynamically configured to handle requests
with the host and port in the URI request path. It will never receive
requests at the root URI (e.g., <code class="docutils literal notranslate"><span class="pre">/index.html</span></code>)</p>
</div>
</li>
<li><p class="first">To proxy <strong>only</strong> the relevant portion of the URI request path to the web
server you would define a <code class="docutils literal notranslate"><span class="pre">LocationMatch</span></code> container in the Apache
configuration file as such:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">LocationMatch</span> <span class="s2">&quot;^/rnode/(?&lt;host&gt;[^]+)/(?&lt;port&gt;\d+)(?&lt;uri&gt;/.*|)&quot;</span><span class="o">&gt;</span>
  <span class="o">...</span>

  <span class="n">LuaHookFixups</span> <span class="n">node_proxy</span><span class="o">.</span><span class="n">lua</span> <span class="n">node_proxy_handler</span>
<span class="o">&lt;/</span><span class="n">LocationMatch</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Note the inclusion of the regular expression named group <code class="docutils literal notranslate"><span class="pre">uri</span></code>. This is
what is sent in the URI request path to the backend web server. So a request
to:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/rnode/host001.hpc.edu/5000/index.html</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">ondemand.hpc.edu</span>
</pre></div>
</div>
<p>will generate a request to the backend web server as:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/index.html</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">host001.hpc.edu</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The backend web server must be configured so that all assets and links
must be relative links. An absolute link to <code class="docutils literal notranslate"><span class="pre">/assets/stylesheet.css</span></code>
will break because the frontend proxy cannot handle this request.</p>
</div>
</li>
</ol>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>For added security it is <strong>recommended</strong> that you replace the above <code class="docutils literal notranslate"><span class="pre">host</span></code>
regular expression named group with a more secure regular expression. For
example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">LocationMatch</span> <span class="s2">&quot;^/node/(?&lt;host&gt;[\w.-]+\.hpc\.edu)/(?&lt;port&gt;\d+)&quot;</span><span class="o">&gt;</span>
  <span class="o">...</span>

  <span class="n">LuaHookFixups</span> <span class="n">node_proxy</span><span class="o">.</span><span class="n">lua</span> <span class="n">node_proxy_handler</span>
<span class="o">&lt;/</span><span class="n">LocationMatch</span><span class="o">&gt;</span>
</pre></div>
</div>
<p class="last">This will only allow proxying to backend web servers within your internal
network.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">Â¶</a></h2>
<p>Configuration is handled by setting CGI environment variables within the Apache
configuration file with the following format:</p>
<div class="highlight-apache notranslate"><div class="highlight"><pre><span></span><span class="nb">SetEnv</span> ARG_FOR_LUA <span class="s2">&quot;value of argument&quot;</span>
</pre></div>
</div>
<dl class="envvar">
<dt id="envvar-OOD_USER_MAP_CMD">
<code class="descname">OOD_USER_MAP_CMD</code><a class="headerlink" href="#envvar-OOD_USER_MAP_CMD" title="Permalink to this definition">Â¶</a></dt>
<dd><p>Absolute path to the script that maps the authenticated user name to the
local user name. See <a class="reference internal" href="../../ood-auth-map.html#ood-auth-map"><span class="std std-ref">ood_auth_map</span></a>.</p>
</dd></dl>

<dl class="envvar">
<dt id="envvar-OOD_USER_ENV">
<code class="descname">OOD_USER_ENV</code><a class="headerlink" href="#envvar-OOD_USER_ENV" title="Permalink to this definition">Â¶</a></dt>
<dd><p><em>Optional</em></p>
<p>Points to the CGI environment variable that stores the authenticated user
name if different than <code class="docutils literal notranslate"><span class="pre">REMOTE_USER</span></code>.</p>
</dd></dl>

<dl class="envvar">
<dt id="envvar-OOD_MAP_FAIL_URI">
<code class="descname">OOD_MAP_FAIL_URI</code><a class="headerlink" href="#envvar-OOD_MAP_FAIL_URI" title="Permalink to this definition">Â¶</a></dt>
<dd><p><em>Optional</em></p>
<p>URL the user redirected to if we fail to map the authenticated user name to
a local user name. If not specified then return an error message to the
user.</p>
</dd></dl>

<dl class="envvar">
<dt id="envvar-MATCH_HOST">
<code class="descname">MATCH_HOST</code><a class="headerlink" href="#envvar-MATCH_HOST" title="Permalink to this definition">Â¶</a></dt>
<dd><p>This is typically set within an Apache <code class="docutils literal notranslate"><span class="pre">LocationMatch</span></code> container using the
regular express named group <code class="docutils literal notranslate"><span class="pre">host</span></code>. This corresponds to the host address
that the userâ€™s traffic is proxied to.</p>
</dd></dl>

<dl class="envvar">
<dt id="envvar-MATCH_PORT">
<code class="descname">MATCH_PORT</code><a class="headerlink" href="#envvar-MATCH_PORT" title="Permalink to this definition">Â¶</a></dt>
<dd><p>This is typically set within an Apache <code class="docutils literal notranslate"><span class="pre">LocationMatch</span></code> container using the
regular express named group <code class="docutils literal notranslate"><span class="pre">port</span></code>. This corresponds to the port number
that the userâ€™s traffic is proxied to.</p>
</dd></dl>

<dl class="envvar">
<dt id="envvar-MATCH_URI">
<code class="descname">MATCH_URI</code><a class="headerlink" href="#envvar-MATCH_URI" title="Permalink to this definition">Â¶</a></dt>
<dd><p><em>Optional</em></p>
<p>This is typically set within an Apache <code class="docutils literal notranslate"><span class="pre">LocationMatch</span></code> container using the
regular express named group <code class="docutils literal notranslate"><span class="pre">uri</span></code>. This is the URI request path passed to
the backend web server. If this is not specified then the full original URI
request path is passed instead.</p>
</dd></dl>

</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="analytics-handler.html" class="btn btn-neutral float-right" title="analytics_handler" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="pun-proxy-handler.html" class="btn btn-neutral float-left" title="pun_proxy_handler" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2019, Ohio Supercomputer Center

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Documentation Versions</span>
    v: 
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Versions</dt>
      
        <dd><a href="https://OSC.github.io/ood-documentation/master/infrastructure/mod-ood-proxy/handlers/node-proxy-handler.html">master</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.6/infrastructure/mod-ood-proxy/handlers/node-proxy-handler.html">1.6</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.5/infrastructure/mod-ood-proxy/handlers/node-proxy-handler.html">1.5</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.4/infrastructure/mod-ood-proxy/handlers/node-proxy-handler.html">1.4</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.3/infrastructure/mod-ood-proxy/handlers/node-proxy-handler.html">1.3</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.2/infrastructure/mod-ood-proxy/handlers/node-proxy-handler.html">1.2</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.1/infrastructure/mod-ood-proxy/handlers/node-proxy-handler.html">1.1</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.0/infrastructure/mod-ood-proxy/handlers/node-proxy-handler.html">1.0</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/develop/infrastructure/mod-ood-proxy/handlers/node-proxy-handler.html">develop</a></dd>
      
    </dl>
    <dl>
      <dt>On GitHub</dt>
        <dd>
          <a href="http://openondemand.org/">Website</a>
        </dd>
        <dd>
          <a href="https://github.com/OSC/Open-OnDemand">Main Repo</a>
        </dd>
    </dl>
    <hr/>
    Theme provided by <a href="http://www.readthedocs.org">Read the Docs</a>.
  </div>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>